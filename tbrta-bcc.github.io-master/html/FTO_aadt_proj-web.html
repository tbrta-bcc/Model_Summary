
<!DOCTYPE html>
<html>
<head>
	<title>Tampa ABM statistics visulization</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!--Load jQuery-->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>


<!-- SEARCH CONTROL -->
	<link rel="stylesheet" href="../src/leaflet-search.css" />


<!-- Chart.js -->	
	<script src="https://cdn.jsdelivr.net/npm/chart.js@3.4.0/dist/chart.min.js"></script>
	
	<link rel="stylesheet" href="../leaflet/leaflet.css"/>
	<script src="../leaflet/leaflet.js"></script> 
	<script src="../js/l.control.geosearch.js"></script>
	<script src="../js/l.geosearch.provider.google.js"></script>
    <link rel="stylesheet" href="../css/l.geosearch.css"/>
    <script src="http://maps.google.com/maps/api/js?v=3.2&sensor=false"></script>
    <script src="http://matchingnotes.com/javascripts/leaflet-google.js"></script>	
	
<!-- Main Style -->
    <link rel="stylesheet" href="../css/ftocount.css"/>

</head>
<body>
	<!-- Geojson -->		
	<script type="text/javascript" src="../geojson/fto_aadt2020_proj.geojson"></script>

	<!-- Title -->
	<nav class="navbar navbar-inverse navbar-fixed-top"> 
		<div class="container-fluid">
			<ul class="nav navbar-nav navbar-left">
				<li><a href="https://tdaappsprod.dot.state.fl.us/fto/"> <h4 style="color: white"> Florida Traffic Online </h4> </a></li>
				<li><a href="#"> <h4 style="color: white"> FDOT D7 Historical AADT (2000-2020) </h4> </a></li>
			</ul>
		</div>
	</nav>

	<!-- Map-->	
	<div id="map"></div>
	
	<div id="cosite">
		<div class="cosite"><h3>Cosite Number:&nbsp;</h3> </div>
		<div class="cosite"><h3 style="color: orange;" id='chartsta'> </h3> </div>
	</div>
	
	<!-- Data Table-->
	<div id="data_table">
		<!--h5><i>FTO AADT Table (2000-2020)</i></h5-->
		<h5 hidden id="tablesta"> </h5>
		<table class="table">
			<thead>
			<tr>
				<th>Year</th>
				<th>AADT</th>
				<th colspan="2">AADT Flag</th>
				<th>Annual Growth</th>
			</tr>
			</thead>
			<tbody>
			<tr>
				<td class="year">2000</td>
				<td class="aadt" id="2000">0</td>
				<td class="aadt_flag" id="2000f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2000"/></td>
				<td class="growth" id='2000g'>0</td>
			</tr>
			<tr>
				<td class="year">2001</td>
				<td class="aadt" id="2001">0</td>
				<td class="aadt_flag" id="2001f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2001"/></td>
				<td class="growth" id='2001g'>0</td>
			</tr>
			<tr>
				<td class="year">2002</td>
				<td class="aadt" id='2002'>0</td>
				<td class="aadt_flag" id="2002f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2002"/></td>
				<td class="growth" id='2002g'>0</td>
			</tr>
			<tr>
				<td class="year">2003</td>
				<td class="aadt" id='2003'>0</td>
				<td class="aadt_flag" id="2003f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2003"/></td>
				<td class="growth" id='2003g'>0</td>
			</tr>
			<tr>
				<td class="year">2004</td>
				<td class="aadt" id='2004'>0</td>
				<td class="aadt_flag" id="2004f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2004"/></td>
				<td class="growth" id='2004g'>0</td>
			</tr>
			<tr>
				<td class="year">2005</td>
				<td class="aadt" id='2005'>0</td>
				<td class="aadt_flag" id="2005f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2005"/></td>
				<td class="growth" id='2005g'>0</td>
			</tr>
			<tr>
				<td class="year">2006</td>
				<td class="aadt" id='2006'>0</td>
				<td class="aadt_flag" id="2006f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2006"/></td>
				<td class="growth" id='2006g'>0</td>
			</tr>
			<tr>
				<td class="year">2007</td>
				<td class="aadt" id='2007'>0</td>
				<td class="aadt_flag" id="2007f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2007"/></td>
				<td class="growth" id='2007g'>0</td>
			</tr>
			<tr>
				<td class="year">2008</td>
				<td class="aadt" id='2008'>0</td>
				<td class="aadt_flag" id="2008f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2008" /></td>
				<td class="growth" id='2008g'>0</td>
			</tr>
			<tr>
				<td class="year">2009</td>
				<td class="aadt" id='2009'>0</td>
				<td class="aadt_flag" id="2009f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2009" /></td>
				<td class="growth" id='2009g'>0</td>
			</tr>
			<tr>
				<td class="year">2010</td>
				<td class="aadt" id='2010'>0</td>
				<td class="aadt_flag" id="2010f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2010" /></td>
				<td class="growth" id='2010g'>0</td>
			</tr>
			<tr>
				<td class="year">2011</td>
				<td class="aadt" id='2011'>0</td>
				<td class="aadt_flag" id="2011f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2011" /></td>
				<td class="growth" id='2011g'>0</td>
			</tr>
			<tr>
				<td class="year">2012</td>
				<td class="aadt" id='2012'>0</td>
				<td class="aadt_flag" id="2012f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2012" /></td>
				<td class="growth" id='2012g'>0</td>
			</tr>
			<tr>
				<td class="year">2013</td>
				<td class="aadt" id='2013'>0</td>
				<td class="aadt_flag" id="2013f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2013" /></td>
				<td class="growth" id='2013g'>0</td>
			</tr>
			<tr>
				<td class="year">2014</td>
				<td class="aadt" id='2014'>0</td>
				<td class="aadt_flag" id="2014f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2014" /></td>
				<td class="growth" id='2014g'>0</td>
			</tr>
			<tr>
				<td class="year">2015</td>
				<td class="aadt" id='2015'>0</td>
				<td class="aadt_flag" id="2015f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2015" /></td>
				<td class="growth" id='2015g'>0</td>
			</tr>
			<tr>
				<td class="year">2016</td>
				<td class="aadt" id='2016'>0</td>
				<td class="aadt_flag" id="2016f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2016" /></td>
				<td class="growth" id='2016g'>0</td>
			</tr>
			<tr>
				<td class="year">2017</td>
				<td class="aadt" id='2017'>0</td>
				<td class="aadt_flag" id="2017f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2017" /></td>
				<td class="growth" id='2017g'>0</td>
			</tr>
			<tr>
				<td class="year">2018</td>
				<td class="aadt" id='2018'>0</td>
				<td class="aadt_flag" id="2018f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2018" /></td>
				<td class="growth" id='2018g'>0</td>
			</tr>
			<tr>
				<td class="year">2019</td>
				<td class="aadt" id='2019'>0</td>
				<td class="aadt_flag" id="2019f">0</td>
				<td class="flag_checker"><input type="checkbox" id="check_2019" /></td>
				<td class="growth" id='2019g'>0</td>
			</tr>
			<tr>
				<td class="year">2020</td>
				<td class="aadt" id='2020'>0</td>
				<td class="aadt_flag" id="2020f">NA</td>
				<td class="flag_checker"><input type="checkbox" id="check_2020" /></td>
				<td class="growth" id='2020g'>0</td>
			</tr>
			</tbody>
		</table>
	</div>

	<!-- Data Chart-->	
	<div id="data_chart">
		<h5><i>FTO AADT Chart (2000-2020)</i></h5>
		<br>
		<canvas id="myChart" height="100"></canvas>
	</div>
	
	<!-- projection Chart-->	
	<div id="data_projection_chart">
		<h5><i>AADT Projection Trend Line (2021-2050)</i></h5>
		<!--select>
		    <option value="5-year">5-Year Estimates</option>
			<option value="10-year">10-Year Estimates</option>
		</select-->
		<canvas id="projChart" height="110"></canvas>
	</div>
	
	
	<!-- Leaflet Search Control -->
	<script src="../src/leaflet-search.js"></script>
	
	<!-- Chart.js -->	
	<script src="https://cdn.jsdelivr.net/npm/chart.js@3.4.0/dist/chart.min.js"></script>

	
	<script type="text/javascript">
	
		var map = L.map('map').setView([28.23, -82.465], 9);
		
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);

		//data Chart
		var LineChartData = {
			labels: ["2000","2001","2002","2003","2004","2005","2006","2007","2008","2009","2010","2011","2012","2013","2014","2015","2016","2017","2018","2019","2020"],
			datasets: [
				{
					label: 'AADT',
					fill: true,
					borderColor: "#FDB45C",
					borderWidth: 1.6,
					pointBackgroundColor: "#FDB45C",
					pointRadius: 4,
					pointBorderWidth: 1,
					tension: 0.3,
					data: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				}																
			]
		};
		
		var ctx = document.getElementById("myChart").getContext("2d");
		var myLineChart = new Chart(ctx, {
			type: 'line',
			data: LineChartData,
			options: {
				scales: {
					y: {
						beginAtZero: true
					}
				},
				plugins: {
					legend: {
						display: false,
					}
				}
			}
		});
	
		//projection Chart
		var LineChartData2 = {
			labels: ["2021","2022","2023","2024","2025","2026","2027","2028","2029","2030","2031","2032","2033","2034","2035","2036","2037","2038","2039","2040","2041","2042","2043","2044","2045","2046","2047","2048","2049","2050"],
			datasets: [
				{	
					label: 'Based on 5-year AADTs',
					borderColor: "#FFBF00",
					borderWidth: 1,
					borderDash: [5,5],
					pointBackgroundColor: "#FFBF00",
					pointRadius: 3,
					pointBorderWidth: 1,
					tension: 0.3,
					data: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				},
				{
					label: 'Based on 10-year AADTs',
					borderColor: "#FF7F50",
					borderWidth: 1,
					borderDash: [5,5],
					pointBackgroundColor: "#FF7F50",
					pointRadius: 3,
					pointBorderWidth: 1,
					//backgroundColor: "rgba(220,220,220,0.2)",
					tension: 0.3,
					data: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
				}

			]
		};
		
		var ctx2 = document.getElementById("projChart").getContext("2d");
		var myLineChart2 = new Chart(ctx2, {
			type: 'line',
			data: LineChartData2,
			options: {
				scales: {
					y: {
						beginAtZero: true
					}
				},
				plugins:{
					legend: {
						labels: {
							usePointStyle: true,
						},
					}
				}
			}
		});
	
	
		// Update information inside division
		var info_10 = L.control();
			
			info_10.onAdd = function (map) {
				this._div = L.DomUtil.create('div', 'info');
				this.update();
				return this._div;
			};
			info_10.update = function (props) {
				this._div.innerHTML = '<h4 align="center">Tampa Bay Region</h4>' 
					+ "Enter a <i><b> Cosite # </b></i> in the Search Box" + '<br><br>' 
					+ (props ? '<b>'+'Cosite #: ' + props.COSITE : '</b>'+'Or click on a FTO station...');
			};
			info_10.addTo(map);
			
		function highlightFeature10(e) {
			var layer = e.target;
			layer.setStyle({
				weight: 5,
				color: '#666',
				dashArray: '',
				fillOpacity: 0.7
			});
			info_10.update(layer.feature.properties);
		}
	
		function resetHighlight10(e) {
			station.resetStyle(e.target);
			info_10.update();
		}

		// get color function	
		function getColor(d) {
			return d > 1100     ?   '#7a0177' :
				d > 800      ?   '#ae017e' :
				d > 500      ?   '#dd3497' :
				d > 300      ?   '#f768a1' :
				d > 200      ?   '#fa9fb5' :
				d > 100      ?   '#fcc5c0' :
				d > 1        ?   '#feebe2' :
									'Gray';
		}
		
		function forecast(x, ky, kx){
		    var i=0, nr=0, dr=0, ax=0, ay=0, a=0, b=0;
			
			function average(array) {
				var total = 0;
				for (var i = 0; i< array.length; i++){
					total += array[i];
				}
				return total/array.length;
			}
		    ax = average(kx);
		    ay = average(ky);
		    for (i = 0; i < kx.length; i++){
		    	nr = nr + ((kx[i]-ax) * (ky[i]-ay));
		    	dr = dr + ((kx[i]-ax) * (kx[i]-ax))
		    }
		    b = nr/dr;
		    a = ay-b*ax;
		    return (a+b*x);
		}


		function whenClicked(e) {
			
			var layer = e.target;	
			
			historicalYears = [2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020];
			historicalCount = [layer.feature.properties.Y2000, 
			layer.feature.properties.Y2001, 
			layer.feature.properties.Y2002, 
			layer.feature.properties.Y2003, 
			layer.feature.properties.Y2004, 
			layer.feature.properties.Y2005, 
			layer.feature.properties.Y2006, 
			layer.feature.properties.Y2007, 
			layer.feature.properties.Y2008, 
			layer.feature.properties.Y2009, 
			layer.feature.properties.Y2010, 
			layer.feature.properties.Y2011, 
			layer.feature.properties.Y2012, 
			layer.feature.properties.Y2013, 
			layer.feature.properties.Y2014, 
			layer.feature.properties.Y2015, 
			layer.feature.properties.Y2016, 
			layer.feature.properties.Y2017, 
			layer.feature.properties.Y2018, 
			layer.feature.properties.Y2019, 
			layer.feature.properties.Y2020];
			
			AADT_flag = [layer.feature.properties.Y2000_FLG, 
			layer.feature.properties.Y2001_FLG, 
			layer.feature.properties.Y2002_FLG, 
			layer.feature.properties.Y2003_FLG, 
			layer.feature.properties.Y2004_FLG, 
			layer.feature.properties.Y2005_FLG, 
			layer.feature.properties.Y2006_FLG, 
			layer.feature.properties.Y2007_FLG, 
			layer.feature.properties.Y2008_FLG, 
			layer.feature.properties.Y2009_FLG, 
			layer.feature.properties.Y2010_FLG, 
			layer.feature.properties.Y2011_FLG, 
			layer.feature.properties.Y2012_FLG, 
			layer.feature.properties.Y2013_FLG, 
			layer.feature.properties.Y2014_FLG, 
			layer.feature.properties.Y2015_FLG, 
			layer.feature.properties.Y2016_FLG, 
			layer.feature.properties.Y2017_FLG, 
			layer.feature.properties.Y2018_FLG, 
			layer.feature.properties.Y2019_FLG, 
			layer.feature.properties.Y2020_FLG];
			

			//update the chart
			myLineChart.data.datasets[0].data = historicalCount;
			myLineChart.update();
			
			//update the Cosite number
			document.getElementById("chartsta").innerHTML = layer.feature.properties.COSITE;
			document.getElementById("tablesta").innerHTML = layer.feature.properties.COSITE;

			const years = 21; //year 2000 - 2020
			var id_year = new Array(years);
			var id_year_growth = new Array(years);
			var id_aadt_flag = new Array(years);
			var annual_growth = new Array(years); 
			var id_checkbox = new Array(years);
			
			for (var i = 0; i < years; i++){
				id_year[i] = String(2000 + i);
				id_year_growth[i] = 2000 + i + 'g';
				id_aadt_flag[i] = 2000 + i + 'f';
				id_checkbox[i] = 'check_' + (2000 + i);
				
				if(i > 0){
					annual_growth[i] = (historicalCount[i-1] === 0 || historicalCount[i-1] === null || historicalCount[i] === 0 || historicalCount[i] === null) ? "NA" 
					: parseFloat(((historicalCount[i]/historicalCount[i-1]-1)*100).toFixed(2))+"%";
				} else {
					annual_growth[i] = "NA"; // No growth rate for the year 2000.
				}
			}
			
			for (var i = 0; i < years; i++){
				document.getElementById(id_year[i]).innerHTML = historicalCount[i];
				document.getElementById(id_year_growth[i]).innerHTML = annual_growth[i];
				document.getElementById(id_aadt_flag[i]).innerHTML = AADT_flag[i];
				document.getElementById(id_checkbox[i]).checked = false;
			}

			const len = 30; //year 2021 - 2050
		    var estimates = new Array(len).fill(0);
		    var estimates2 = new Array(len).fill(0);
			
			// 2020 aadt is considered as an outlier if it is less than the begin year aadt.
			var aadt = historicalCount.slice(-5);
			var year = historicalYears.slice(-5);
			if(historicalCount[20] < historicalCount[16]){
				aadt = historicalCount.slice(-6, -1);
				year = historicalYears.slice(-6, -1); 
			}
			
			var i = 0;
			while (i < aadt.length) {
				if (aadt[i] === 0) {
					aadt.splice(i, 1);
					year.splice(i, 1);
				} else {
					++i;
				}
			}
			
			for(var i = 0; i < len; i++){
				estimates[i] = Math.round(Math.max(0, forecast(2021+i, aadt, year)));
			}
			
			
			var aadt2 = historicalCount.slice(-10);
			var year2 = historicalYears.slice(-10);
			var check2 = id_checkbox.slice(-10);
			if(historicalCount[20] < historicalCount[11]){
				var aadt2 = historicalCount.slice(-11, -1);
				var year2 = historicalYears.slice(-11, -1);
				var check2 = id_checkbox.slice(-11, -1);
			}
			
			var i = 0;
			while(i < aadt2.length){
				if (aadt2[i] === 0) {
					aadt2.splice(i, 1);
					year2.splice(i, 1);
					check2.splice(i, 1);
				} else {
					++i;
				}
			}
			
			for(var i = 0; i < check2.length; i++){
				document.getElementById(check2[i]).checked = true;
			}
			
			for(var i = 0; i < len; i++){
				estimates2[i] = Math.round(Math.max(0, forecast(2021+i, aadt2, year2)));
			}
			
			myLineChart2.data.datasets[0].data = estimates;
			myLineChart2.data.datasets[1].data = estimates2;
			myLineChart2.update();
		}
		
		//on each feature function		
		function onEachFeature(feature, layer) {
		    layer.on({
			    mouseover: highlightFeature10,
				mouseout: resetHighlight10,
			    click: whenClicked});
				
			var popupContent = "<p style='line-height: 1.5em'> <u><b>Cosite #:</b></u> " + feature.properties.COSITE + '<br>' 
					+'<u><b>Description:</b></u> '+ feature.properties.COMM +'<br>' 
					+'<u><b>2020 AADT:</b></u> '+ feature.properties.Y2020 +"</p>" ;

			if (feature.properties && feature.properties.popupContent) {
				popupContent += feature.properties.popupContent;
			}

			layer.bindPopup(popupContent);
		}

		
		var station = L.geoJson( geo, {
			style: function (feature) {
				return feature.properties && feature.properties.style;
			},

			onEachFeature: onEachFeature,

			pointToLayer: function (feature, latlng) {
				return L.circleMarker(latlng, {
					radius: 4,
					fillColor: "#ff7800",
					color: "#000",
					weight: 1,
					opacity: 1,
					fillOpacity: 0.8
				});
			}
		}).addTo(map);


	    // search control
		var searchControl = new L.Control.Search({
			layer: station, 
			propertyName: 'COSITE', 
			autoCollapse:true,
			moveToLocation: function(latlng, title, map) {
				//map.fitBounds( latlng.layer.getBounds() );
					var zoom = map.getBoundsZoom(latlng.layer.getBounds());
					map.setView(latlng, zoom); // access the zoom
					}});
	
		searchControl.on('search:locationfound', function(e) {
		
		//document.getElementById("checkbox").checked = true;
			
			historicalYears = [2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020];
			historicalCount = [e.layer.feature.properties.Y2000, 
			e.layer.feature.properties.Y2001, 
			e.layer.feature.properties.Y2002, 
			e.layer.feature.properties.Y2003, 
			e.layer.feature.properties.Y2004, 
			e.layer.feature.properties.Y2005, 
			e.layer.feature.properties.Y2006, 
			e.layer.feature.properties.Y2007, 
			e.layer.feature.properties.Y2008, 
			e.layer.feature.properties.Y2009, 
			e.layer.feature.properties.Y2010, 
			e.layer.feature.properties.Y2011, 
			e.layer.feature.properties.Y2012, 
			e.layer.feature.properties.Y2013, 
			e.layer.feature.properties.Y2014, 
			e.layer.feature.properties.Y2015, 
			e.layer.feature.properties.Y2016, 
			e.layer.feature.properties.Y2017, 
			e.layer.feature.properties.Y2018, 
			e.layer.feature.properties.Y2019, 
			e.layer.feature.properties.Y2020];
			
			AADT_flag = [e.layer.feature.properties.Y2000_FLG, 
			e.layer.feature.properties.Y2001_FLG, 
			e.layer.feature.properties.Y2002_FLG, 
			e.layer.feature.properties.Y2003_FLG, 
			e.layer.feature.properties.Y2004_FLG, 
			e.layer.feature.properties.Y2005_FLG, 
			e.layer.feature.properties.Y2006_FLG, 
			e.layer.feature.properties.Y2007_FLG, 
			e.layer.feature.properties.Y2008_FLG, 
			e.layer.feature.properties.Y2009_FLG, 
			e.layer.feature.properties.Y2010_FLG, 
			e.layer.feature.properties.Y2011_FLG, 
			e.layer.feature.properties.Y2012_FLG, 
			e.layer.feature.properties.Y2013_FLG, 
			e.layer.feature.properties.Y2014_FLG, 
			e.layer.feature.properties.Y2015_FLG, 
			e.layer.feature.properties.Y2016_FLG, 
			e.layer.feature.properties.Y2017_FLG, 
			e.layer.feature.properties.Y2018_FLG, 
			e.layer.feature.properties.Y2019_FLG, 
			e.layer.feature.properties.Y2020_FLG];
			
			myLineChart.data.datasets[0].data = historicalCount;
			myLineChart.update();
			
			//update the Cosite number
			document.getElementById("chartsta").innerHTML = e.layer.feature.properties.COSITE;
			document.getElementById("tablesta").innerHTML = e.layer.feature.properties.COSITE;

			//update the data table - AADT
			const years = 21; //year 2000 - 2020
			var id_year = new Array(years);
			var id_year_growth = new Array(years);
			var id_aadt_flag = new Array(years);
			var annual_growth = new Array(years); 
			var id_checkbox = new Array(years);
			
			for (var i = 0; i < years; i++){
				id_year[i] = String(2000 + i);
				id_year_growth[i] = 2000 + i + 'g';
				id_aadt_flag[i] = 2000 + i + 'f';
				id_checkbox[i] = 'check_' + (2000 + i);
				
				if(i > 0){
					annual_growth[i] = (historicalCount[i-1] === 0 || historicalCount[i-1] === null || historicalCount[i] === 0 || historicalCount[i] === null) ? "NA" 
					: parseFloat(((historicalCount[i]/historicalCount[i-1]-1)*100).toFixed(2))+"%";
				} else {
					annual_growth[i] = "NA"; // No growth rate for the year 2000.
				}
			}
			
			for (var i = 0; i < years; i++){
				document.getElementById(id_year[i]).innerHTML = historicalCount[i];
				document.getElementById(id_year_growth[i]).innerHTML = annual_growth[i];
				document.getElementById(id_aadt_flag[i]).innerHTML = AADT_flag[i];
				document.getElementById(id_checkbox[i]).checked = false;
			}

			const len = 30; //year 2021 - 2050
		    var estimates = new Array(len).fill(0);
		    var estimates2 = new Array(len).fill(0);
			
			// 2020 aadt is considered as an outlier if it is less than the begin year aadt.
			var aadt = historicalCount.slice(-5);
			var year = historicalYears.slice(-5);
			if(historicalCount[20] < historicalCount[16]){
				aadt = historicalCount.slice(-6, -1);
				year = historicalYears.slice(-6, -1); 
			}
			
			var i = 0;
			while (i < aadt.length) {
				if (aadt[i] === 0) {
					aadt.splice(i, 1);
					year.splice(i, 1);
				} else {
					++i;
				}
			}
			
			for(var i = 0; i < len; i++){
				estimates[i] = Math.round(Math.max(0, forecast(2021+i, aadt, year)));
			}
			
			
			var aadt2 = historicalCount.slice(-10);
			var year2 = historicalYears.slice(-10);
			var check2 = id_checkbox.slice(-10);
			if(historicalCount[20] < historicalCount[11]){
				var aadt2 = historicalCount.slice(-11, -1);
				var year2 = historicalYears.slice(-11, -1);
				var check2 = id_checkbox.slice(-11, -1);
			}
			
			var i = 0;
			while(i < aadt2.length){
				if (aadt2[i] === 0) {
					aadt2.splice(i, 1);
					year2.splice(i, 1);
					check2.splice(i, 1);
				} else {
					++i;
				}
			}
			
			for(var i = 0; i < check2.length; i++){
				document.getElementById(check2[i]).checked = true;
			}
			
			for(var i = 0; i < len; i++){
				estimates2[i] = Math.round(Math.max(0, forecast(2021+i, aadt2, year2)));
			}
			
			myLineChart2.data.datasets[0].data = estimates;
			myLineChart2.data.datasets[1].data = estimates2;
			myLineChart2.update();
			

			e.layer.setStyle({fillColor: '#3f0', color: '#0f0'});
			if(e.layer._popup)
				e.layer.openPopup();
		}).on('search:collapsed', function(e) {
			station.eachLayer(function(layer) {	//restore feature color
				station.resetStyle(layer);
			});	
		});
		
		map.addControl(searchControl);  //inizialize search control

	</script>

</body>
</html>
